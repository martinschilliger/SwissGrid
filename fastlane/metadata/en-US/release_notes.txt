A complete rewrite for iOS 11 (finally).